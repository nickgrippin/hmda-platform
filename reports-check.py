import requests
import subprocess
import re

def main():
    missFile = open("missed_reports", "a")
    totalInstitutions = len(instList)
    print("{} institutions to check...".format(totalInstitutions))

    for i, inst in enumerate(instList):
        if (i % 25 == 0):
            print("checking {} ({} of {})".format(inst, i, totalInstitutions))

        msaList = lsList(s3BaseUrl + str(inst) + "/")

        for msa in msaList:
            reportList = fileList(inst, msa)
            if msa == "nationwide":
                missed = checkNationwide(reportList)
            else:
                missed = checkMSAReports(reportList)

            for report in missed:
                missFile.write("{},{},{}\n".format(inst, msa, report))

    missFile.close()


def cleanOutput(line):
    ln = line.lstrip().strip("/")
    return re.sub(r"^PRE ","",ln)

def lsList(uri):
    output = subprocess.getoutput(lsCommand + uri)
    ls = []
    for line in output.split('\n'):
        cleaned = cleanOutput(line)
        ls.append(cleaned)
    return ls

def fileList(inst, msa):
    output = subprocess.getoutput(lsCommand + s3BaseUrl + str(inst) + "/" + msa + "/")
    files = []
    for line in output.split('\n'):
        fileName = re.findall(r"\S+txt",line)[0].split(".")[0]
        files.append(fileName)
    return files

def checkNationwide(list):
    expected = ['A1W', 'A2W', 'A3W', 'BW', 'IRS']
    if len(list) < len(expected):
        missing = expected
        for report in list:
            missing.remove(report)
    else:
        missing = []
    return missing

def checkMSAReports(list):
    expected = ['1', '11-1', '11-10', '11-2', '11-3', '11-4', '11-5', '11-6', '11-7', '11-8', '11-9', '12-1', '12-2', '2', '3-1', '3-2', '4-1', '4-2', '4-3', '4-4', '4-5', '4-6', '4-7', '5-1', '5-2', '5-3', '5-4', '5-6', '5-7', '7-1', '7-2', '7-3', '7-4', '7-5', '7-6', '7-7', '8-1', '8-2', '8-3', '8-4', '8-5', '8-6', '8-7', 'A1', 'A2', 'A3', 'A4W', 'B']
    if len(list) < len(expected):
        missing = expected
        for report in list:
            missing.remove(report)
    else:
        missing = []
    return missing


s3BaseUrl = "s3://cfpb-hmda-public/prod/reports/disclosure/2017/"
lsCommand = "aws s3 ls "
#instList = lsList(s3BaseUrl)
instList = [
"3876390",
"3877641",
"1017939",
"261146",
"4323949",
"4183732",
"3837038",
"3955361",
"613307",
"45-5510883",
"99189",
"3850082",
"664756",
"663245",
"631570",
"202907",
"659855",
"4324982",
"3837270",
"3842368",
"1223440",
"4429908",
"3885187",
"2634191",
"3904930",
"724904",
"656377",
"3851557",
"4533609",
"288853",
"4184766",
"131490",
"3885794",
"3845734",
"5023910",
"858975",
"3282852",
"4878038",
"2917317",
"2925666",
"3592047",
"734499",
"601050",
"4186863",
"4325635",
"3870419",
"45-5523107",
"3072606",
"666581",
"3848810",
"3947843",
"2855914",
"652874",
"694904",
"4533618",
"4323716",
"463735",
"3871966",
"27-1438405",
"4889892",
"4437798",
"3877566",
"4533588",
"601489",
"3153130",
"3881509",
"3882805",
"384278",
"322793",
"1007846",
"4728919",
"3876710",
"3944226",
"208244",
"527954",
"225698",
"277697",
"3877089",
"245276",
"945978",
"3872039",
"3837252",
"3952191",
"3880995",
"509950",
"3871920",
"3844410",
"937898",
"2489805",
"961624",
"339072",
"5027262",
"4437789",
"3845846",
"3868827",
"342634",
"5134115",
"3862021",
"764030",
"3875647",
"723112",
"3876354",
"611198",
"25085",
"3955192",
"46-3435079",
"416245",
"211271",
"540926",
"929352",
"972590",
"3913697",
"3896071",
"3913624",
"2747587",
"413208",
"491224",
"4437592",
"3914135",
"3954328",
"5083268",
"3897452",
"5023657",
"739560",
"3954944",
"2737980",
"5023684",
"3120329",
"276579",
"491381",
"4325626",
"4182771",
"3882533",
"3410114",
"2797724",
"749242",
"4437583",
"598534",
"1864722",
"697633",
"542649",
"722777",
"940311",
"4741561",
"4183741",
"3876112",
"4320416",
"3896101",
"3955370",
"606046",
"2724047",
"379920",
"651596",
"3885299",
"244149",
"4114567",
"595270",
"804963",
"3878385",
"4187235",
"3871528",
"3844465",
"3876224",
"3429509",
"4437873",
"483386",
"2212665",
"911973",
"808176",
"917742",
"2508751",
"177957",
"546571",
"4323912",
"3886456",
"30810",
"3877379",
"3873401",
"4185428",
"3837261",
"460592",
"3877623",
"3915310",
"3851584",
"4183684",
"3876345",
"2618780",
"3914032",
"4188036",
"4186573",
"02-0486480",
"339858",
"143662",
"311845",
"4922025",
"4142337",
"3875179",
"75633",
"3868779",
"3870606",
"212465",
"3873456",
"2590037",
"656733",
"4184793",
"3875713",
"3883099",
"4379151",
"312730",
"3897443",
"4320117",
"1189117",
"501105",
"4730163",
"4533159",
"4188175",
"112837",
"3955754",
"4437716",
"280110",
"258771",
"2891622",
"3904891",
"4183602",
"3303298",
"3332935",
"497404",
"436159",
"4320902",
"3877575",
"3914377",
"3851427",
"3966143",
"3882515",
"4325019",
"3332551",
"3378018",
"4878010",
"3881732",
"3955651",
"12311",
"3246939",
"3844577",
"4184805",
"2712969",
"3897500",
"2735146",
"3949593",
"3876998",
"20-8921389",
"3955491",
"233031",
"3881554",
"4438179",
"476810",
"3882793",
"3955923",
"675332",
"3875692",
"2888798",
"3247123",
"3842407",
"852320",
"3236088",
"3958157",
"3870099",
"1936928",
"1569885",
"3896932",
"817824",
"1072246",
"3913576",
"619877",
"3954355",
"3870651",
"146672",
"3871751",
"3861163",
"617677",
"480228",
"3871519",
"4186591",
"4438209",
"3966116",
"504713",
"3935523",
"852218",
"3870679",
"451965",
]

main()

            #print(reportList)
        #print(msaList)
        #print("{} MSAs for {}".format(len(msaList) - 1, inst))
        #print(".")
                #if len(missed) > 0:
                    #print("{}: nationwide reports missing: {}".format(inst, missed))
                #if len(missed) > 0:
                    #print("{}: reports for MSA {} missing: {}".format(inst, msa, missed))

